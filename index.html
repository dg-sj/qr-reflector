<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Scanner & Regenerator</title>
  <!-- Include jsQR for scanning QR codes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
  <!-- Include QRCode.js for generating QR codes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; padding: 20px; }
    video { width: 90%; max-width: 400px; margin: 20px auto; }
    #qrcode canvas { margin: 20px auto; }
    #shareButton { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>QR Scanner & Regenerator</h1>
  <!-- Video element to display the camera stream -->
  <video id="video" autoplay playsinline></video>
  <!-- Hidden canvas to grab video frames -->
  <canvas id="canvas" hidden></canvas>
  <!-- Container for the regenerated QR code and share button -->
  <div id="output" hidden>
    <p>Regenerated QR Code:</p>
    <div id="qrcode"></div>
    <button id="shareButton">Share QR Code</button>
  </div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const output = document.getElementById("output");
    const qrcodeDiv = document.getElementById("qrcode");
    let qrData = null;

    // Request access to the device camera
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          video.play();
        })
        .catch(err => {
          console.error("Camera access denied:", err);
          alert("Unable to access the camera.");
        });
    } else {
      alert("Camera access is not supported by your browser.");
    }

    // Once video data is available, scan continuously for a QR code.
    video.addEventListener("loadeddata", () => {
      const context = canvas.getContext("2d");

      const scan = () => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          // Set canvas dimensions to match video dimensions
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          // Use jsQR to scan the image data for a QR code
          let code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code) {
            qrData = code.data;
            console.log("QR code detected:", qrData);
            // Stop the video stream after detection
            video.srcObject.getTracks().forEach(track => track.stop());
            // Display the output and generate the QR code
            output.hidden = false;
            generateQRCode(qrData);
            return;
          }
        }
        requestAnimationFrame(scan);
      };

      scan();
    });

    // Function to generate a QR code using the detected data
    function generateQRCode(data) {
      // Clear any existing QR code content
      qrcodeDiv.innerHTML = "";
      new QRCode(qrcodeDiv, {
        text: data,
        width: 256,
        height: 256
      });
    }

    // Share the regenerated QR code image using the Web Share API
    document.getElementById("shareButton").addEventListener("click", async () => {
      if (!qrData) return;

      // Convert the QR code from the canvas into a blob
      const qrCanvas = qrcodeDiv.querySelector("canvas");
      if (!qrCanvas) {
        alert("QR code image not found!");
        return;
      }

      qrCanvas.toBlob(async blob => {
        const file = new File([blob], "qrcode.png", { type: blob.type });
        const filesArray = [file];
        if (navigator.canShare && navigator.canShare({ files: filesArray })) {
          try {
            await navigator.share({
              files: filesArray,
              title: "QR Code",
              text: "Here is the regenerated QR code."
            });
          } catch (err) {
            console.error("Error sharing:", err);
            alert("Sharing failed.");
          }
        } else {
          alert("File sharing is not supported on this device.");
        }
      });
    });
  </script>
</body>
</html>

